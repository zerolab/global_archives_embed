for(var tm,lookup,countries={},filters=[],cm={},icons=[],i=1;80>i;i++)icons[i]=generateIcon(i);for(cc in lookup)cm[cc]={},cm[cc].latlng=new GLatLng(lookup[cc].lat,lookup[cc].lon),cm[cc].marker=null,cm[cc].items=[],cm[cc].urls=[],cm[cc].name=null;lookup=null;
$(function(){var a=$(window).height(),b=$("#timeline-controls").outerHeight();$("#mapcontainer").css("height",a-b-100+"px");$(window).resize(function(){var a=$(window).height(),b=$("#timeline-controls").outerHeight();$("#mapcontainer").css("height",a-b-100+"px")});tm=TimeMap.init({mapId:"map",timelineId:"timeline",scrollTo:"now",options:{mapType:"normal",mapCenter:new GLatLng(30,18),showMapTypeCtrl:!1},datasets:[{id:"bloggers",title:"Bloggers",type:"jsonp",options:{url:"http://threatened.globalvoicesonline.org/data/items.json&callback=",
preloadFunction:function(a){return a.items}}}],bandIntervals:[Timeline.DateTime.MONTH,Timeline.DateTime.YEAR],dataDisplayedFunction:function(a){a.addFilterChain("counter",function(a){var b=a.opts.cc;isNaN(countries[b])?countries[b]=1:countries[b]++;if("undefined"!=typeof cm[b]){var c=cm[b].items.indexOf(a.getTitle());if(!cm[b].name)cm[b].name=a.opts.c;-1==c&&(cm[b].items.push(a.getTitle()),cm[b].urls.push(a.opts.url))}},function(){});a.addFilter("counter",function(a){return TimeMap.filters.hideFuture(a)});
a.filter("counter");if(!filters.length)for(cc in countries)0<countries[cc]&&dynamicSizeMarker(cc,countries[cc]);updateTimeframe(a.timeline.getBand(0));$(".timeline-message-container").hide();a.timeline.getBand(0).addOnScrollListener(function(){updateTimeframe(a.timeline.getBand(0));countries={};a.filter("counter");if(!filters.length)for(cc in cm)if(0<countries[cc])dynamicSizeMarker(cc,countries[cc]);else if(cm[cc].marker)a.map.removeOverlay(cm[cc].marker),cm[cc].marker=null})}});tm.addFilter("timeline",
TimeMap.filters.hasSelectedTag);tm.addFilter("map",TimeMap.filters.hasSelectedTag);tm.addFilter("map",TimeMap.filters.showAll);$("#filters").attr("checked",!0);$("#filters input[type=checkbox]:not('#tm-all')").each(function(){$(this).attr("checked",!1)});$("#filters input[type=checkbox]").click(function(){var a=$(this).val(),b=filters.indexOf(a);if($(this).is(":checked"))if("All"==a)filters=[],$("#filters input[type=checkbox]:not('#tm-all')").each(function(){$(this).attr("checked",!1)});else{var c=
$("#tm-all");c.is(":checked")&&c.attr("checked",!1);removeSizeMarkers();if(-1==b){filters.push(a);tm.filter("timeline");tm.timeline.layout();tm.datasets.bloggers.each(function(a){for(_filter in filters)if(-1!=a.opts.tags.indexOf(filters[_filter]))a.showPlacemark(),a.visible=!0});return}}else-1!=b&&filters.splice(b,1);tm.filter("map");tm.filter("timeline");tm.timeline.layout()});var c=new Date;$("#navigation button").click(function(){var a=$(this).attr("title");"earliest"==a?tm.timeline.getBand(0).setCenterVisibleDate(tm.eventSource.getEarliestDate()):
"latest"==a?tm.timeline.getBand(0).setCenterVisibleDate(tm.eventSource.getLatestDate()):tm.timeline.getBand(0).setCenterVisibleDate(c);return!1})});TimeMap.filters.hideFuture=function(a){var b=a.dataset.timemap.timeline.getBand(0).getMaxVisibleDate().getTime();return null!==a.event&&a.event.getStart().getTime()>b?(b=cm[a.opts.cc].items.indexOf(a.getTitle()),-1!=b&&(cm[a.opts.cc].items.splice(b,1),cm[a.opts.cc].urls.splice(b,1)),!1):!0};
TimeMap.filters.hasSelectedTag=function(a){return!filters.length?!0:a.opts.tags?0<=filters.indexOf(a.opts.tags):!1};TimeMap.filters.showAll=function(){return!filters.length?!1:!0};function generateIcon(a){var b=Math.round(64*(a-1)/80+16),c={};c.width=b;c.height=b;c.primaryColor="#ff0000";c.label=""+a;c.labelSize=12;c.labelColor="#1f1f1f";c.shape="circle";return MapIconMaker.createFlatIcon(c)}
function dynamicSizeMarker(a,b){if("undefined"!=typeof cm[a])cm[a].marker&&tm.map.removeOverlay(cm[a].marker),cm[a].marker=new GMarker(cm[a].latlng,{icon:icons[b]}),GEvent.addListener(cm[a].marker,"click",function(){cm[a].marker.openInfoWindowHtml(htmlList(cm[a].items,cm[a].urls,a))}),tm.map.addOverlay(cm[a].marker)}
function htmlList(a,b,c){for(var c='<div class="infodescription list">'+('<h2><img src="http://threatened.globalvoicesonline.org/sites/all/themes/gv_threatened/images/flags/'+c.toLowerCase()+'.gif"> <a href="http://threatened.globalvoicesonline.org/bloggers/'+cm[c].name+'" target=_blank>'+cm[c].name+"</a></h2>"),d=0;d<a.length;d++)c+='<a href="http://threatened.globalvoicesonline.org/'+b[d]+'" target=_blank>'+a[d]+"</a><br/>";return c+"</div>"}
function removeSizeMarkers(){for(cc in cm)if(cm[cc].marker)tm.map.removeOverlay(cm[cc].marker),cm[cc].marker=null}function updateTimeframe(a){var b=(new String(a.getMinVisibleDate())).split(/\s/),a=(new String(a.getMaxVisibleDate())).split(/\s/),b=b[1]+" "+(!$.browser.msie?b[3]:b[b.length-1]),a=a[1]+" "+(!$.browser.msie?a[3]:a[a.length-1]);$("#timeframe").html(b+" - "+a)}
if("undefined"==typeof Array.indexOf)Array.prototype.indexOf=function(a,b,c){for(var b=+b||0,d=this.length;b<d;b++)if(this[b]===a||c&&this[b]==a)return b;return-1};